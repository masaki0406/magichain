
# エルドリッチホラー Online 仕様書・設計書（完全版）

本書は、協力型ボードゲーム「エルドリッチホラー（Eldritch Horror）」を
オンラインで再現・実装するための **仕様書および設計書** である。
基本セットを対象とし、拡張は将来対応とする。

---

## 1. 目的・スコープ

### 1.1 目的
- エルドリッチホラーのルールを正確にデジタル再現する
- オンラインで複数人が協力プレイできる環境を提供する
- 乱数・両面カード・大量コンポーネント管理を安全に扱う

### 1.2 対象範囲
- 基本セットの全ルール
- 1〜8人プレイ
- セーブ / ロード / 再接続

### 1.3 非対象（初期）
- 拡張セット
- AIプレイヤー
- ランキング・課金要素

---

## 2. 勝利条件・敗北条件

### 2.1 勝利条件
- ミステリーカードを規定枚数（通常3枚）解決する

### 2.2 敗北条件
- 探索者が全員脱落（体力0または正気度0）
- 神話カード山札が尽きた状態で勝利していない
- 破滅トラックが0となり、邪神覚醒後の敗北条件を満たす

※ 勝利と敗北が同時に成立した場合は「勝利」

---

## 3. ゲーム進行フロー

### 3.1 ラウンド構成
1. アクションフェーズ
2. 遭遇フェーズ
3. 神話フェーズ

### 3.2 アクションフェーズ
- 各探索者は最大2アクション
- 同一アクションは1ラウンド1回まで
- 主なアクション
  - 移動
  - 休息
  - 資産獲得
  - 交換
  - カード/探索者固有アクション

### 3.3 遭遇フェーズ
- 探索者ごとに1回
- 優先順位
  1. モンスター戦闘
  2. ゲート遭遇
  3. 手がかり遭遇
  4. 遠征遭遇
  5. 通常遭遇
  6. 状態カード遭遇

### 3.4 神話フェーズ
- 神話カードを1枚引く
- 記載アイコンを上から順に解決
  - 予兆進行
  - 清算
  - ゲート出現
  - モンスターサージ
  - 手がかり出現
  - 噂配置
  - イベント効果

---

## 4. ダイス判定仕様

### 4.1 基本
- 能力値 = d6 個数
- 成功目：5, 6

### 4.2 修正要素
- 装備・呪文・状態によるダイス追加
- 再ロール効果
- 成功目拡張（祝福）

---

## 5. コンポーネント管理

### 5.1 デッキ・トークン
- 神話カード
- 遭遇カード（都市 / 荒野 / 海）
- 異界カード
- リサーチカード（邪神別）
- 遠征カード
- 資産カード（予備4枚）
- 呪文カード（両面）
- 状態カード（両面）
- モンスタートークン
- ゲートトークン
- 手がかりトークン

### 5.2 両面カードの非公開性
- 裏面は解決タイミングまで非公開
- サーバーのみ完全情報を保持

---

## 6. オンラインUI要件

### 6.1 表示
- 世界地図盤面
- 探索者・モンスター・トークン配置
- フェーズ / 手番表示
- 公開情報パネル
- 個人情報パネル
- 操作ログ

### 6.2 操作
- フェーズ駆動UI
- ダイスロールUI
- カード解決ウィザード

---


---

## 7. システム設計

### 7.1 技術スタック
- **Frontend**: Next.js (React) + TypeScript
- **Hosting**: Vercel
- **Backend**: Firebase Functions (Node.js)
- **Database**: Firestore (NoSQL)
- **Auth**: Firebase Authentication
- **Realtime**: Firestore Realtime Listeners

### 7.2 アーキテクチャ詳細
- **クライアント (Next.js)**:
    - UI描画、ユーザー入力の受付
    - Firestoreの変更を検知して画面を更新 (スナップショットリスナー)
    - アクション実行時は Cloud Functions を呼び出す (直接DB書き込みは禁止)
- **サーバー (Cloud Functions)**:
    - **Game Engine**: ルール判定の核心部分。
    - **Action Handlers**: 「移動」「攻撃」「休息」などのユーザーアクションを受け取り、正当性を検証してStateを更新する。
    - **Phase Manager**: 全員の行動終了を検知し、自動で次のフェーズ/プレイヤーへ手番を回す。
    - **Automation System**: カード効果（「意志判定を行う」等）を解析し、ダイスロール処理やステータス増減を自動実行する。

### 7.3 データモデル設計 (Firestore)

#### `games/{gameId}`
ゲーム全体の進行状態を管理。
```typescript
interface GameState {
  phase: 'ACTION' | 'ENCOUNTER' | 'MYTHOS';
  round: number;
  activePlayerId: string; // 現在手番のプレイヤー
  turnState: {
    actionsTaken: number; // 現在のプレイヤーが消費したアクション数
    finishedPlayers: string[]; // そのフェーズの行動を終えたプレイヤーIDリスト
  };
  mythosDeck: string[]; // カードIDの配列
  reserveAssets: string[]; // 資産予備
  // ...その他盤面情報
}
```

#### `games/{gameId}/players/{playerId}`
各プレイヤーの状態。
```typescript
interface PlayerState {
  investigatorId: string;
  health: number;
  sanity: number;
  location: string; // 現在地 (例: "Tokyo")
  items: string[]; // 所持カードID
  conditions: string[]; // 状態カードID
  stats: {
    lore: number;
    influence: number;
    observation: number;
    strength: number;
    will: number;
  };
}
```

---

## 8. ゲームロジック詳細要件

### 8.1 完全自動化 (Full Automation)
- **カード効果**: 全てのカードデータに「効果スクリプト」を持たせる。
    - 例: `{ type: "TEST", skill: "will", mod: -1, success: { type: "GAIN_CLUE", amount: 1 }, fail: { type: "LOSE_SANITY", amount: 1 } }`
- **ダイスロール**: サーバー側で乱数を生成し、結果のみをクライアントに通知。不正防止を徹底する。
- **パラメータ管理**: ダメージや正気度減少は、効果解決時に自動で減算される。

### 8.2 進行管理 (Auto-Progression)
- **ターン遷移**: プレイヤーが「アクション終了」または規定回数（2回）のアクションを行うと、自動的に `activePlayerId` が次のプレイヤーに変更される。
- **フェーズ遷移**: 全員がアクションを終えると、自動的に「遭遇フェーズ」へ移行する。

### 8.3 マップと移動 (Pathfinding)
- **経路計算**: グラフ理論に基づき、現在地から移動可能な隣接ノードをサーバー（またはクライアント）で計算。
- **ハイライト**: 移動アクション選択時、移動可能なマスのみをハイライト表示し、クリックで移動を実行する。
- **チケット消費**: 鉄道・船チケットが必要な経路の場合、所持チェックと自動消費を行う。

---

## 9. 開発ロードマップ (改訂版)

### Phase 1: コアエンジンと移動
- プロジェクトセットアップ (Next.js + Firebase)
- マップデータ構造の定義と経路探索ロジックの実装
- プレイヤーの移動アクションとターン遷移の実装

### Phase 2: 遭遇と自動判定システム
- 遭遇カードのデータ構造化
- ダイスロール機能とスキル判定ロジック
- 成功/失敗によるステータス自動変動の実装

### Phase 3: 神話フェーズと全体ループ
- 神話カードの効果実装
- ラウンド進行のループ完成
- ゲーム終了条件（勝利/敗北）の判定

### Phase 4: UI/UX磨き込み
- アニメーション、SE
- チュートリアル、操作ガイド

---

## 10. 注意事項
- **データ入力コスト**: 完全自動化のため、数百枚のカード効果を全てデータ入力（スクリプト化）する必要がある。
- **デバッグ**: 自動処理が多いため、特定の状況を再現するデバッグ機能が必須となる。

---

（End of Document）
