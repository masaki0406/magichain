# MAGI CHAIN（マギチェイン）
## オンライン実装用ルール仕様 & システム指示書 v3
（Firebase + Vercel / セーブ・ロード・再接続対応）

---

## 0. 目的

- ボードゲーム **MAGI CHAIN（マギチェイン）** をオンライン対応で実装する
- 途中経過を **常時保存** し、
  - ゲーム中に落ちても **同一プレイヤーとして復帰可能**
  - ロビーから **保存済みゲームをロード** 可能
- ルールは **確定済み部分を完全再現** し、状態遷移はサーバー主導で管理する

---

## 1. ゲーム概要

- プレイ人数：1〜4人
- プレイヤーは魔術師となり、カードプレイによってリソースを獲得し、
  - 移動
  - マスアクション
  - チェイン・精霊発動
  を行い、勝利点（VP）を競う。

---

## 2. カード仕様

### 2.1 カード属性（5種類）

| 色 | 属性 | 意味 |
|---|---|---|
| 白 | 無属性 | チェインの中立要素 |
| 赤 | 攻撃 | 攻撃力（魔物討伐） |
| 青 | 移動 | 移動力 |
| 緑 | 知力 | 購入・改良リソース |
| 黄 | ドロー | カードドロー |

> カードは **プレイフェイズで並べた順序** が重要

---

## 3. 基本リソース（正規化）

```ts
resources = {
  move: number,   // 青
  attack: number, // 赤
  intel: number,  // 緑
  draw: number    // 黄
}
```

---

## 4. 手番の流れ（確定）

### 4.1 フェイズ構成

1. **プレイフェイズ**
   - 手札からカードを **何枚でもプレイ可能**
   - プレイしたカードは **場札（順序付き配列）** に並ぶ
   - カード効果によりリソースを獲得

2. **精霊発動フェイズ**
   - 精霊カードに記載された **色の並び** と
     - プレイフェイズで並べたカードの **並びが完全一致** した場合、発動
   - 精霊が複数ある場合：
     - それぞれ独立に判定
     - 条件を満たしていれば **任意の順序で発動可能**
   - 精霊とは別に：
     - カードに記載された **抽出属性** が一致すると **追加能力発動**

3. **移動フェイズ**
   - プレイフェイズで得た `move` の数まで移動可能
   - 移動は任意で、使い切る必要はない

4. **マスアクションフェイズ**
   - 最終的に止まったマスの効果を **1回発動**

5. **場札排出**
   - 場に出ていたカードをすべて **捨て札へ**

6. **手札補充**
   - `draw` の数だけカードを引く
   - 手札上限：**8枚**
   - 山札がなくなった場合：
     - 捨て札をシャッフルして山札を再構築

---

## 5. マスの種類と制約

### 5.1 マス種類

| マス | 内容 |
|---|---|
| 都市マス | 納品・貢献・魔物納品 |
| 危険な道 | 特殊効果 |
| 属性マス | 属性対応効果 |
| 聖樹の子株マス | 成長・改良 |
| 魔物マス | 魔物と遭遇 |

### 5.2 同一マス制限

- **都市マス以外**：2人以上は同時に止まれない
- 都市マスのみ複数人可

---

## 6. マスアクション（主要アクション）

### 6.1 学習
- `intel` を支払いマギカードを獲得

### 6.2 改良
- `intel` / `attack` / 部品トークンを支払い能力強化

### 6.3 契約
- `intel` を支払い精霊カードを獲得

### 6.4 論文（受注・納品）
- 論文カードには **行き先都市** が記載
- 受注後は **バックパック** に保持
- 指定都市に到達すると納品可能

### 6.5 魔物討伐
- 魔物の体力以上の `attack` が必要
- 討伐後はバックパックに入り、任意の都市で納品可能

---

## 7. ゲーム終了条件（OR条件）

以下のいずれかで即終了：

1. 発展トラックの **部品トークン枯渇**
2. **マギカード山札** のいずれかが枯渇
3. 大陸ボード上 **10箇所の地脈スペース** が全て非魔物化
4. **6箇所の論文** のいずれかが 0 枚

---

## 8. 終了時得点計算

### 8.1 同名貢献マジョリティ
- 各都市ごと、最多納品プレイヤーは **10点**

### 8.2 褒章
- 納品済み論文・魔晶に記載の点数

### 8.3 旅の道具
- 改良済み旅の道具に記載された VP

### 8.4 精霊
- 精霊カード **1枚につき 4点**

### 8.5 デッキボーナス
- デッキ上部記載のボーナス点

### 8.6 ノイズ
- ノイズカード **1枚につき −3点**

---

## 9. セーブ・ロード・復帰設計

### 9.1 プレイヤー識別
- Firebase Authentication の `auth.uid` を使用

### 9.2 ゲーム中断からの復帰

1. 再ログイン
2. `players.userId == auth.uid` のゲーム検索
3. `status == running` を自動表示
4. 復帰

### 9.3 ロビーからのロード

- 自分が参加したゲーム一覧を表示
- `lobby / running / finished` すべてロード可能

### 9.4 セーブ方式

- 各アクション後に **オートセーブ**
- `snapshotVersion` による世代管理
- 全アクションは `events` に記録

---

## 10. ルールエンジン方針

```ts
reduce(gameState, action) -> newGameState
```

- 完全純関数
- サーバー側で検証
- Firestore Transaction 内で実行

---

## 11. Codex 実装指示まとめ

- Firestore を唯一の正とする
- 復帰可能なオンラインボードゲームとして実装
- ルールは ruleset として差し替え可能にする

---

（このファイルは Codex / Claude Code / ChatGPT Code に直接投入可能）
